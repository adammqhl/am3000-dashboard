<script>
  // --- CONFIG ---
  const API_URL = 'https://script.google.com/macros/s/AKfycbySCaYNySVZFB4GcPgcXGAQiaWRsqE_Esj93keeqzuvd7BbnojTkkl87r_xtCanf4c7uQ/exec';
  const correctPassword = "AM3000";

  // --- STATE ---
  let isEditMode = false;
  let currentCapacityData = {}; 
  let globalProductionQueue = []; 
  let selectedDays = new Set(); 
  let arrowConnections = [];

  const modelVariantMapping = {
    hrv: [ { name: "S", index: 0 }, { name: "E", index: 1 }, { name: "V", index: 2 }, { name: "HEV", index: 3 } ],
    wrv: [ { name: "LESS", index: 4 }, { name: "E", index: 5 }, { name: "V", index: 6 }, { name: "RS", index: 7 } ],
    city4d: [ { name: "S", index: 8 }, { name: "E", index: 9 }, { name: "V", index: 10 }, { name: "RS", index: 11 }, { name: "HEV", index: 12 } ],
    city5d: [ { name: "S", index: 13 }, { name: "E", index: 14 }, { name: "V", index: 15 }, { name: "RS", index: 16 }, { name: "HEV", index: 17 } ]
  };

  // --- FETCH DATA FROM SHEET ---
  async function fetchMonthData(month, year) {
    try {
      const res = await fetch(`${API_URL}?action=fetch&month=${month}&year=${year}`);
      const data = await res.json();
      currentCapacityData = data;
    } catch (err) {
      console.error("Failed to fetch month data:", err);
    }
  }

  // --- SAVE TO SHEET ---
  async function saveTargetsToSheet() {
    const payload = { action: "update", data: currentCapacityData };
    try {
      const res = await fetch(API_URL, {
        method: "POST",
        body: JSON.stringify(payload),
        headers: { "Content-Type": "application/json" }
      });
      const result = await res.json();
      alert(result.message || "Saved successfully!");
    } catch (err) {
      console.error("Failed to save data:", err);
      alert("Error saving data!");
    }
  }

  // --- INITIALIZE MONTH DATA ---
  function initializeMonthData(month, year) {
    currentCapacityData = {};
    const daysInMonth = new Date(year, month + 1, 0).getDate();
    for (let day = 1; day <= daysInMonth; day++) {
      const date = new Date(year, month, day);
      const dayOfWeek = date.getDay();
      let dCap = 0, nCap = 0, total = 0, ot = "0";
      if (dayOfWeek >= 1 && dayOfWeek <= 4) { dCap = 99; nCap = 97; total = 196; } 
      else if (dayOfWeek === 5) { dCap = 85; nCap = 97; total = 182; }
      currentCapacityData[day] = { dayCap: dCap, nightCap: nCap, total: total, otLabel: ot };
    }
    globalProductionQueue = [];
    selectedDays.clear();
    arrowConnections = [];
    document.getElementById('current-sequence-list').innerHTML = '';
  }

  // --- GENERATE TABLE ---
  function generateTable(month, year) {
    const tbody = document.getElementById('production-schedule-body');
    tbody.innerHTML = ''; 
    const daysInMonth = new Date(year, month + 1, 0).getDate();
    let allDayRows = '';
    for (let day = 1; day <= daysInMonth; day++) {
      const blockNumber = Math.floor((day - 1) / 14);
      const dayShiftLabel = (blockNumber % 2 === 0) ? "A" : "B";
      const nightShiftLabel = (blockNumber % 2 === 0) ? "B" : "A";
      const dayData = currentCapacityData[day] || { dayCap: 0, nightCap: 0, total: 0, otLabel: "0" };
      const dayStr = new Date(year, month, day).toLocaleDateString('en-US', { weekday: 'short' });
      allDayRows += createRowHTML(day, dayStr, "day", dayShiftLabel, dayData.total, dayData.otLabel, dayData.dayCap);
      allDayRows += createRowHTML(day, dayStr, "night", nightShiftLabel, dayData.total, dayData.otLabel, dayData.nightCap);
    }
    tbody.innerHTML = allDayRows;
    const monthShortName = new Date(year, month, 1).toLocaleString('default', { month: 'short' });
    const firstRow = tbody.querySelector('tr[data-day-number="1"]');
    if(firstRow) firstRow.insertAdjacentHTML('afterbegin', `<td class="month-cell-merged" rowspan="${daysInMonth*2}">${monthShortName} ${year}</td>`);
  }

  function createRowHTML(dayNum, dayStr, shiftName, shiftLabel, total, ot, cap) {
    const format = (v) => (v == 0 || v == "0" || v === "") ? "" : v;
    const variants = '<td class="data-cell"></td>'.repeat(18); 
    const isNonProd = (total === 0);
    const rowClass = isNonProd ? "non-production-row" : "";
    return `
      <tr class="${rowClass}" data-day-number="${dayNum}" data-shift="${shiftName}">
        ${shiftName === 'day' ? `<td rowspan="2" class="day-number-cell">${dayNum}, ${dayStr}</td><td rowspan="2" class="daily-target-cell">${format(total)}</td><td rowspan="2" class="ot-plan-cell">${format(ot)}</td>` : ''}
        <td class="shift-label day-night-target-cell">${format(cap)}</td>
        <td class="shift-label">${shiftLabel}</td>
        ${variants}
      </tr>
    `;
  }

  // --- ARROWS ---
  function drawArrowOverlay() {
    const svg = document.getElementById('arrow-overlay');
    const defs = svg.innerHTML.split('</defs>')[0] + '</defs>';
    svg.innerHTML = defs;
    const tableRect = document.querySelector('table').getBoundingClientRect();
    arrowConnections.forEach(conn => {
      if (!conn.from || !conn.to) return;
      const r1 = conn.from.getBoundingClientRect();
      const r2 = conn.to.getBoundingClientRect();
      const startX = r1.left + r1.width / 2 - tableRect.left;
      const startY = r1.bottom - 2 - tableRect.top;
      const endX = r2.left + r2.width / 2 - tableRect.left;
      const endY = r2.top + 2 - tableRect.top; 
      if (Math.abs(endX - startX) < 10 && Math.abs(endY - startY) < 10) return;
      const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
      const controlPointY1 = startY + 15;
      const controlPointY2 = endY - 15;
      const d = `M ${startX} ${startY} C ${startX} ${controlPointY1}, ${endX} ${controlPointY2}, ${endX} ${endY}`;
      path.setAttribute('d', d);
      path.setAttribute('class', 'connection-path');
      path.setAttribute('marker-end', 'url(#arrowhead)');
      svg.appendChild(path);
    });
  }

  window.addEventListener('resize', drawArrowOverlay);

  // --- PASSWORD / EDIT ---
  const toggleButton = document.getElementById('edit-toggle-btn');
  const passwordPrompt = document.getElementById('password-prompt');
  const passwordInput = document.getElementById('password-input');
  const editingPanel = document.getElementById('editing-panel-container');

  toggleButton.addEventListener('click', () => {
    if (isEditMode) {
      isEditMode = false; toggleButton.textContent = 'Unlock Editing';
      toggleButton.classList.remove('locked'); editingPanel.classList.remove('visible');
    } else {
      passwordPrompt.style.display = 'block'; passwordInput.focus();
    }
  });

  passwordInput.addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
      if (passwordInput.value === correctPassword) {
        isEditMode = true; toggleButton.textContent = 'Lock Dashboard';
        toggleButton.classList.add('locked'); passwordPrompt.style.display = 'none';
        passwordInput.value = ''; editingPanel.classList.add('visible');
      } else { document.getElementById('password-error').textContent = 'Wrong Password'; }
    }
  });

  // --- INITIALIZE ---
  initializeMonthData(10, 2025); generateTable(10, 2025);
</script>
